<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>AutenticaÃ§Ã£o Facial</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilo.css') }}">
</head>
<body>
    <div class="interface-principal">

            <div class="camera-box">
                <h1>AutenticaÃ§Ã£o Facial</h1>
                <video id="video" autoplay playsinline></video>
                <p id="resultado"></p>
                <button id="botaoTeste" onclick="verificarRosto()" style="display:none;">Verificar Rosto</button>
            </div>

            <div class="instrucoes-box">
                <h2>ğŸ“‹ InstruÃ§Ãµes para Reconhecimento</h2>
                <ul>
                    <li>ğŸŸ¢ Mantenha o rosto centralizado na cÃ¢mera.</li>
                    <li>ğŸ’¡ Esteja em um ambiente bem iluminado, sem luz forte atrÃ¡s de vocÃª.</li>
                    <li>ğŸ˜ Mantenha uma expressÃ£o neutra, sem exageros.</li>
                    <li>ğŸ§¢ Evite Ã³culos escuros, mÃ¡scaras ou bonÃ©s que cubram o rosto.</li>
                    <li>ğŸ“ Fique a uma distÃ¢ncia mÃ©dia â€” nem muito perto, nem muito longe.</li>
                    <li>ğŸ“± Evite movimentar o rosto durante a verificaÃ§Ã£o.</li>
                </ul>
            </div>

            <div class="acoes-box">
                <a href="/seguranca-relatorios" class="botao-relatorio">ğŸ“Š RelatÃ³rios</a>
                <a href="/seguranca" class="cadastro-link">ğŸ“ Cadastrar</a>
            </div>
        
    </div>

    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

    <script>
        let bloqueado = false;
        let reconhecido = false;
        let stream;

        window.onload = () => {
            const video = document.getElementById('video');

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(s => {
                    stream = s;
                    video.srcObject = stream;
                    document.getElementById('botaoTeste').style.display = 'inline-block';
                })
                .catch(err => {
                    document.getElementById('resultado').innerText = "Erro ao acessar a cÃ¢mera.";
                    console.error("Erro na webcam:", err);
                });
        };

        function verificarRosto() {
            if (bloqueado || reconhecido) return;

            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            if (!video || !canvas || !context) return;

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imagem = canvas.toDataURL('image/png');

            fetch('/verificar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imagem })
            })
            .then(res => res.json())
            .then(data => {
                const resultado = document.getElementById('resultado');

                if (data.redirect) {
                    reconhecido = true;
                    if (stream) stream.getTracks().forEach(track => track.stop());
                    window.location.href = data.redirect;
                }

                if (data.mensagem) {
                    resultado.className = 'erro';
                    resultado.innerText = data.mensagem;
                    resultado.style.display = 'block';
                    bloqueado = true;

                    setTimeout(() => {
                        bloqueado = false;
                        resultado.innerText = '';
                        resultado.className = '';
                        resultado.style.display = 'none';
                    }, 10000);
                }
            })
            .catch(err => {
                const resultado = document.getElementById('resultado');
                resultado.className = 'erro';
                resultado.innerText = "Erro na verificaÃ§Ã£o.";
                resultado.style.display = 'block';
                console.error("Erro na verificaÃ§Ã£o:", err);

                setTimeout(() => {
                    resultado.innerText = '';
                    resultado.className = '';
                    resultado.style.display = 'none';
                }, 10000);
            });
        }
    </script>
</body>
</html>